<!doctype html>
<title>Bubble Game</title>
<script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>
<style>
  html, body { 
    margin: 0;
    height: 100%;
    overflow: hidden;
    background: #eee;
  }
  canvas {
    position: absolute;
  }
  .count {
    position: absolute;
    left: 13px;
    top: 8px;
    font-family: sans-serif;
  }
</style>
<body>
  <div class="count"></div>
<script>
  // shim layer with setTimeout fallback
  window.requestAnimFrame = (function(){
    return  window.requestAnimationFrame       || 
            window.webkitRequestAnimationFrame || 
            window.mozRequestAnimationFrame    || 
            window.oRequestAnimationFrame      || 
            window.msRequestAnimationFrame     || 
            function( callback ){
              window.setTimeout(callback, 1000 / 60);
            };
  })();
  
  var isTouchDevice = 'ontouchstart' in document.documentElement ? true : false;
  
  function normalizedX(event){
    return isTouchDevice ? event.touches[0].pageX : event.pageX;
  }

  function normalizedY(event){
    return isTouchDevice ? event.touches[0].pageY : event.pageY;
  }
  
  function Bubble(id, x, y, vx, vy){
    this.canvas = document.createElement('canvas');
    this.canvas.id = id;
    this.ctx = this.canvas.getContext('2d');
    this.startX = this.x = x;
    this.startY = this.y = y;
    this.vx = vx;
    this.vy = vy;
    this.maxRadius = 34;
    this.color = 'hsl('+ [Math.random()*360, '100%', '50%'].join(", ") + ')';
    this.generate();
  }
  
  Bubble.prototype = {
    generate : function(){
      var angle = Math.PI * Math.random();
      
      this.targetDistance = 10 + Math.random() * 150;
      this.distance = 0;
      
      this.targetX = 0.5*-Math.sin(angle) * this.targetDistance + this.vx * 20;
      this.targetY = 0.5*Math.cos(angle) * this.targetDistance + this.vy * 20;
      
      this.radius = 1;
      this.isX = Math.random() > 0.5 ? true : false;
      this.filled = Math.random() > 0.5 ? true : false;
      this.targetStrokeSize = Math.round(Math.random() * this.maxRadius/2);
      
      this.draw();
    },
    draw : function(){
      var center = this.maxRadius+this.targetStrokeSize/2;
      
      this.canvas.width = center*2;
      this.canvas.height = center*2;
      
      this.canvas.style.webkitTransform = 'translate3d('+ this.x +'px,'+ this.y +'px,0) scale(0)'; 
      this.canvas.style.margin = -center+"px 0 0 "+ (-center) + "px";
      
      this.ctx.beginPath();
      this.ctx.arc(center, center, this.maxRadius, 0, 2 * Math.PI, true);
      if(!this.isX){
        this.ctx.lineWidth = this.targetStrokeSize;
        this.ctx.strokeStyle = this.color;
        this.ctx.stroke();
      }
      if(this.isX && this.filled){
        this.ctx.fillStyle = this.color;
        this.ctx.fill();
      }
      if(this.isX){
        var v = 0.47*this.maxRadius;
        
        this.ctx.save();
        this.ctx.beginPath();
        this.ctx.lineWidth = this.maxRadius/4;
        this.ctx.lineCap = "round";
        
        if(this.filled){
          this.ctx.strokeStyle = "black";
          this.ctx.globalCompositeOperation = "destination-out";
        } else {
          this.ctx.strokeStyle = this.color;
        }
        
        // draw the x
        this.ctx.moveTo(center-v, center-v);
        this.ctx.lineTo(center+v, center+v);
        this.ctx.moveTo(center+v, center-v);
        this.ctx.lineTo(center-v, center+v);
        
        this.ctx.stroke();
        this.ctx.restore();
      }
    },
    update : function(){
      this.distance++;
      this.percentage = this.distance/this.targetDistance;
      
      // move
      this.x = this.startX + this.targetX * this.percentage;
      this.y = this.startY + this.targetY * this.percentage;
      
      return this.targetDistance < this.distance;
    }
  };
  
  function World(element){
    this.element = element;
    
    this.idCount = 0;
    
    this.positionX = this.element.innerWidth/2;
    this.positionY = this.element.innerHeight/2;
    
    this.velocityX = 0;
    this.velocityY = 0;
    
    this.speed = 4;
    
    this.distanceToLastBubble = 0;
    
    this.keyTable = {
      38 : "top",
      39 : "right",
      40 : "bottom",
      37 : "left"
    };
    
    this.inputPressed = false;
    document.addEventListener('keydown', this.keydown.bind(this));
    document.addEventListener('keyup', this.keyup.bind(this));
    document.addEventListener(isTouchDevice ? 'touchmove' : 'mousemove', this.moveHandler.bind(this));
    document.addEventListener(isTouchDevice ? 'touchstart' : 'mousedown', this.inputDown.bind(this));
    document.addEventListener(isTouchDevice ? 'touchend' : 'mouseup', this.inputUp.bind(this));
    
    
    this.countElement = document.querySelector('.count');
    
    this.bubbles = new Array();
    this.render();
  }
  
  World.prototype = {
    render : function(){
      requestAnimFrame( this.render.bind(this) );
      
      this.countElement.innerText = this.bubbles.length;
      
      this.positionX += this.velocityX;
      this.positionY += this.velocityY;
      
      // if the user moves, generate a new bubble and add it to the dom
      if(this.velocityX || this.velocityY) this.newBubble();
      
      for(var i=0; i<this.bubbles.length; i++){
        var bubble = this.bubbles[i];
        var hasArrivedAtTargetPosition = bubble.update();
        
        
        // update css position, opacity and size
        bubble.canvas.style.webkitTransform = 'translate3d('+ bubble.x +'px,'+ bubble.y +'px,0) scale('+ bubble.percentage +')'; 
        bubble.canvas.style.opacity = 1-bubble.percentage;
        
        if(hasArrivedAtTargetPosition){
          this.element.removeChild( document.getElementById(bubble.canvas.id) );
          this.bubbles.splice(i,1)[0];
        }
      }
    },
    newId : function(){
      return this.idCount++;
    },
    newBubble : function(){
      this.distanceToLastBubble++;
      
      if(Math.random() < this.distanceToLastBubble/50 || this.inputPressed){
        var bubble = new Bubble(this.newId(), this.positionX, this.positionY, this.velocityX, this.velocityY);
        this.bubbles.push(bubble);
        
        this.element.appendChild(bubble.canvas);
        
        this.distanceToLastBubble = 0;
      }
    },
    keydown : function(event){
      this.move( this.keyTable[event.keyCode] );
    },
    keyup : function(event){
      this.stopToMove( this.keyTable[event.keyCode] );
    },
    inputDown : function(event){
      this.inputPressed = true;
      this.moveHandler();
    },
    inputUp : function(){
      this.inputPressed = false;
    },
    moveHandler : function(event){
      this.velocityX = normalizedX(event) - this.positionX;
      this.velocityY = normalizedY(event) - this.positionY;
      
      if(this.velocityX < -0.5) this.velocityX = -this.speed;
      if(this.velocityX >  0.5) this.velocityX =  this.speed;
      
      if(this.velocityY < -0.5) this.velocityY = -this.speed;
      if(this.velocityY >  0.5) this.velocityY =  this.speed;
      
      this.positionX = normalizedX(event);
      this.positionY = normalizedY(event);
      
      this.newBubble();
    },
    move : function(direction){
      switch(direction){
        case 'left':
          this.velocityX = -this.speed;
          break;            
        case 'top':         
          this.velocityY = -this.speed;
          break;            
        case 'right':       
          this.velocityX = this.speed;
          break;            
        case 'bottom':      
          this.velocityY = this.speed;
          break;
      }
    },
    stopToMove : function(direction){
      switch(direction){
        case 'left': case 'right':
          this.velocityX = 0;
          break;
        case 'top': case 'bottom':
          this.velocityY = 0;
          break;
      }
    }
  };
  
  var world = new World( document.querySelector('body') );
</script>